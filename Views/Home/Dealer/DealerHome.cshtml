@using Newtonsoft.Json
@model HaldiramPromotionalApp.ViewModels.DealerDashboardViewModel

@{
    ViewData["Title"] = "Dealer Dashboard";
    // Set the total points in ViewData so it can be accessed in the layout
    ViewData["TotalPoints"] = Model.TotalPoints;
    
    // Prevent the layout from rendering its bottom navigation
    ViewData["HideLayoutBottomNav"] = true;

    // Function to get category image URLs
    string GetCategoryImageUrl(string category)
    {
        return category switch
        {
            "Dairy Products" => "https://plus.unsplash.com/premium_photo-1695042864778-6d67ec3953e9?ixlib=rb-4.1.0&auto=format&fit=crop&q=80&w=870",
            "Bakery Products" => "https://images.unsplash.com/photo-1598373182133-52452f7691ef?ixlib=rb-4.1.0&auto=format&fit=crop&q=80&w=870",
            _ => "https://images.unsplash.com/photo-1605020420320-3460820a7d67?ixlib=rb-4.1.0&auto=format&fit=crop&q=80&w=870"
        };
    }

    // Function to get points for a material from active campaigns
    int GetPointsForMaterial(int materialId)
    {
        var points = 0;

        // Check PointsToCash campaigns
        foreach (var campaign in Model.Campaigns.DetailedPointsToCashCampaigns.Where(c => c.IsActive))
        {
            if (!string.IsNullOrEmpty(campaign.MaterialPoints))
            {
                try
                {
                    var materialPoints = JsonConvert.DeserializeObject<Dictionary<string, int>>(campaign.MaterialPoints);
                    if (materialPoints != null && materialPoints.ContainsKey(materialId.ToString()))
                    {
                        points = Math.Max(points, materialPoints[materialId.ToString()]);
                    }
                }
                catch
                {
                    // Ignore deserialization errors
                }
            }
        }

        // Check PointsReward campaigns
        foreach (var campaign in Model.Campaigns.DetailedPointsRewardCampaigns.Where(c => c.IsActive))
        {
            if (!string.IsNullOrEmpty(campaign.MaterialPoints))
            {
                try
                {
                    var materialPoints = JsonConvert.DeserializeObject<Dictionary<string, int>>(campaign.MaterialPoints);
                    if (materialPoints != null && materialPoints.ContainsKey(materialId.ToString()))
                    {
                        points = Math.Max(points, materialPoints[materialId.ToString()]);
                    }
                }
                catch
                {
                    // Ignore deserialization errors
                }
            }
        }

        return points;
    }
}

@Html.AntiForgeryToken()
<link rel="stylesheet" href="~/css/DealerDashboard.css" />

@if (Context.Session.GetString("UserName") == null || Context.Session.GetString("role") != "Dealer")
{
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Access Denied</h4>
        <p>You must be logged in as a Dealer to access this page.</p>
        <hr>
        <a href="@Url.Action("Login", "Home")" class="btn btn-primary">Go to Login</a>
    </div>
}
else
{
    <div class="dashboard-container">

        <!-- Posters Carousel -->
        @if (Model.Posters != null && Model.Posters.Any())
        {
            <div id="posterCarousel" class="carousel slide carousel-container" data-bs-ride="carousel">
                <div class="carousel-inner">
                    @for (int i = 0; i < Model.Posters.Count; i++)
                    {
                        var poster = Model.Posters[i];
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <div class="carousel-item-content">
                                @if (!string.IsNullOrEmpty(poster.ImagePath))
                                {
                                    <img src="@poster.ImagePath" alt="@poster.Message" class="product-image">
                                    <div class="carousel-gradient"></div>
                                }
                                <div class="carousel-text">
                                    <h3 class="carousel-title">@poster.Message</h3>
                                    <div class="carousel-dates">
    <span>From: @poster.ShowFrom.ToString("dd/MM/yyyy")</span>
    <span>Until: @poster.ShowUntil.ToString("dd/MM/yyyy")</span>
</div>

                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (Model.Posters.Count > 1)
                {
                    <button class="carousel-control-prev" type="button" data-bs-target="#posterCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#posterCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    <div class="carousel-indicators">
                        @for (int i = 0; i < Model.Posters.Count; i++)
                        {
                            <button type="button" data-bs-target="#posterCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="true" aria-label="Slide @(i+1)"></button>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">No updates available at the moment.</div>
            </div>
        }

        <!-- Active Campaigns -->
        <div class="campaigns-section">
            <h2 class="section-header">Active Campaigns</h2>
            @{
                var hasCampaigns = Model.Campaigns.DetailedPointsToCashCampaigns.Any() ||
                                   Model.Campaigns.DetailedPointsRewardCampaigns.Any() ||
                                   Model.Campaigns.DetailedFreeProductCampaigns.Any() ||
                                   Model.Campaigns.AmountReachGoalCampaigns.Any() ||
                                   Model.Campaigns.SessionDurationRewardCampaigns.Any();
            }

            @if (hasCampaigns)
            {
                <div class="campaigns-slider-container">
                    <div class="campaigns-slider">
                        <!-- Points to Cash -->
                        @foreach (var c in Model.Campaigns.DetailedPointsToCashCampaigns)
                        {
                            <div class="campaign-card">
                                <div class="campaign-image">
                                    <img src="@(c.ImagePath ?? "https://placehold.co/600x400/cccccc/000000?text=No+Image")" alt="@c.CampaignName" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/000000?text=No+Image';">
                                </div>
                                <div class="campaign-header">
                                    <h3 class="campaign-title">@c.CampaignName</h3>
                                    <span class="badge @(c.IsActive ? "badge-active" : "badge-inactive")">
                                        @(c.IsActive ? "Active" : "Inactive")
                                    </span>
                                </div>
                                <div class="campaign-info">
                                    <div class="info-row"><span class="info-label">Start:</span> <span class="date-value">@c.StartDate.ToString("dd MMM yyyy")</span></div>
                                    <div class="info-row"><span class="info-label">End:</span> <span class="date-value">@c.EndDate.ToString("dd MMM yyyy")</span></div>
                                   
                                </div>
                                <button type="button" class="details-btn" onclick="showDetails('pointsToCash-@c.Id')">Show Details</button>
                                <div id="pointsToCash-@c.Id" class="campaign-details hidden">
                                    <div class="info-row"><span class="info-label">Threshold:</span> @c.VoucherGenerationThreshold points</div>
                                    <div class="info-row"><span class="info-label">Voucher:</span> ₹@c.VoucherValue</div>
                                    @if (!string.IsNullOrEmpty(c.Description))
                                    {
                                        <div class="mt-3"><span class="info-label d-block mb-1">Description:</span><p class="text-muted small">@c.Description</p></div>
                                        <div class="info-row"><span class="info-label">Validity:</span> @c.VoucherValidity days</div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Points Reward -->
                        @foreach (var c in Model.Campaigns.DetailedPointsRewardCampaigns)
                        {
                            <div class="campaign-card">
                                <div class="campaign-image">
                                    <img src="@(c.ImagePath ?? "https://placehold.co/600x400/cccccc/000000?text=No+Image")" alt="@c.CampaignName" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/000000?text=No+Image';">
                                </div>
                                <div class="campaign-header">
                                    <h3 class="campaign-title">@c.CampaignName</h3>
                                    <span class="badge @(c.IsActive ? "badge-active" : "badge-inactive")">
                                        @(c.IsActive ? "Active" : "Inactive")
                                    </span>
                                </div>
                                <div class="campaign-info">
                                    <div class="info-row"><span class="info-label">Start:</span> <span class="date-value">@c.StartDate.ToString("dd MMM yyyy")</span></div>
                                    <div class="info-row"><span class="info-label">End:</span> <span class="date-value">@c.EndDate.ToString("dd MMM yyyy")</span></div>
                                
                                </div>
                                <button type="button" class="details-btn" onclick="showDetails('pointsReward-@c.Id')">Show Details</button>
                                <div id="pointsReward-@c.Id" class="campaign-details hidden">
                                    <div class="info-row"><span class="info-label">Threshold:</span> @c.VoucherGenerationThreshold points</div>
                                    @if (c.RewardProduct != null)
                                    {
                                        <div class="mt-3"><span class="info-label d-block mb-1">Reward:</span><strong>@c.RewardProduct.ProductName</strong></div>
                                    }
                                    @if (!string.IsNullOrEmpty(c.Description))
                                    {
                                        <div class="mt-3"><span class="info-label d-block mb-1">Description:</span><p class="text-muted small">@c.Description</p></div>
                                        <div class="info-row"><span class="info-label">Validity:</span> @c.VoucherValidity days</div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Free Product -->
                        @foreach (var c in Model.Campaigns.DetailedFreeProductCampaigns)
                        {
                            <div class="campaign-card">
                                <div class="campaign-image">
                                    <img src="@(c.ImagePath ?? "https://placehold.co/600x400/cccccc/000000?text=No+Image")" alt="@c.CampaignName" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/000000?text=No+Image';">
                                </div>
                                <div class="campaign-header">
                                    <h3 class="campaign-title">@c.CampaignName</h3>
                                    <span class="badge @(c.IsActive ? "badge-active" : "badge-inactive")">
                                        @(c.IsActive ? "Active" : "Inactive")
                                    </span>
                                </div>
                                <div class="campaign-info">
                                    <div class="info-row"><span class="info-label">Start:</span> @c.StartDate.ToString("dd/MM/yyyy")</div>
                                    <div class="info-row"><span class="info-label">End:</span> @c.EndDate.ToString("dd/MM/yyyy")</div>
                                </div>
                                <button type="button" class="details-btn" onclick="showDetails('freeProduct-@c.Id')">Show Details</button>
                                <div id="freeProduct-@c.Id" class="campaign-details hidden">
                                    @if (c.FreeProductDetails?.Any() == true)
                                    {
                                        <div class="mt-3">
                                            <span class="info-label d-block mb-1">Free Products:</span>
                                            @foreach (var kvp in c.FreeProductDetails)
                                            {
                                                <p class="mb-1"><strong>@kvp.Value.FreeProductName</strong> (Qty: @kvp.Value.FreeQuantity)</p>
                                            }
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(c.Description))
                                    {
                                        <div class="mt-3"><span class="info-label d-block mb-1">Description:</span><p class="text-muted small">@c.Description</p></div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Amount Reach -->
                        @foreach (var c in Model.Campaigns.AmountReachGoalCampaigns)
                        {
                            <div class="campaign-card">
                                <div class="campaign-image">
                                    <img src="@(c.ImagePath ?? "https://placehold.co/600x400/cccccc/000000?text=No+Image")" alt="@c.CampaignName" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/000000?text=No+Image';">
                                </div>
                                <div class="campaign-header">
                                    <h3 class="campaign-title">@c.CampaignName</h3>
                                    <span class="badge @(c.IsActive ? "badge-active" : "badge-inactive")">
                                        @(c.IsActive ? "Active" : "Inactive")
                                    </span>
                                </div>
                                <div class="campaign-info">
                                    <div class="info-row"><span class="info-label">Start:</span> @c.StartDate.ToString("dd/MM/yyyy")</div>
                                    <div class="info-row"><span class="info-label">End:</span> @c.EndDate.ToString("dd/MM/yyyy")</div>
                                    
                                </div>
                                <button type="button" class="details-btn" onclick="showDetails('amountReach-@c.Id')">Show Details</button>
                                <div id="amountReach-@c.Id" class="campaign-details hidden">
                                    @if (!string.IsNullOrEmpty(c.Description))
                                    {
                                        <div class="mt-3"><span class="info-label d-block mb-1">Description:</span><p class="text-muted small">@c.Description</p></div>
                                        <div class="info-row"><span class="info-label">Target:</span> ₹@c.TargetAmount</div>
                                        <div class="info-row"><span class="info-label">Voucher:</span> ₹@c.VoucherValue</div>
                                        <div class="info-row"><span class="info-label">Validity:</span> @c.VoucherValidity days</div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Session Duration -->
                        @foreach (var c in Model.Campaigns.SessionDurationRewardCampaigns)
                        {
                            <div class="campaign-card">
                                <div class="campaign-image">
                                    <img src="@(c.ImagePath ?? "https://placehold.co/600x400/cccccc/000000?text=No+Image")" alt="@c.CampaignName" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/000000?text=No+Image';">
                                </div>
                                <div class="campaign-header">
                                    <h3 class="campaign-title">@c.CampaignName</h3>
                                    <span class="badge @(c.IsActive ? "badge-active" : "badge-inactive")">
                                        @(c.IsActive ? "Active" : "Inactive")
                                    </span>
                                </div>
                                <div class="campaign-info">
                                    <div class="info-row"><span class="info-label">Start:</span> @c.StartDate.ToString("dd/MM/yyyy")</div>
                                    <div class="info-row"><span class="info-label">End:</span> @c.EndDate.ToString("dd/MM/yyyy")</div>
                                   
                                </div>
                                <button type="button" class="details-btn" onclick="showDetails('sessionDuration-@c.Id')">Show Details</button>
                                <div id="sessionDuration-@c.Id" class="campaign-details hidden">
                                    @if (!string.IsNullOrEmpty(c.Description))
                                    {
                                        <div class="mt-3"><span class="info-label d-block mb-1">Description:</span><p class="text-muted small">@c.Description</p></div>
                                        <div class="info-row"><span class="info-label">Session:</span> @c.SessionDuration mins</div>
                                        <div class="info-row"><span class="info-label">Voucher:</span> ₹@c.VoucherValue</div>
                                        <div class="info-row"><span class="info-label">Validity:</span> @c.VoucherValidity days</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">No active campaigns at the moment.</div>
                </div>
            }
        </div>

        <!-- Recent Order -->
        <div class="campaigns-section">
            <h2 class="section-header">Repeat Order</h2>
            @if (Model.RecentDealerBasicOrders != null && Model.RecentDealerBasicOrders.Any())
            {
                <div class="recent-order-container">
                    <div class="order-header">
                        <div class="order-info">
                            <h3 class="order-title">Repeat Orders</h3>
                            <span class="badge badge-active">Active</span>
                        </div>
                        <div class="order-details">
                            <div class="info-row"><span class="info-label">Total Items:</span> @Model.RecentDealerBasicOrders.Count()</div>
                        </div>
                    </div>

                    <div class="order-items-grid">
                        @foreach (var item in Model.RecentDealerBasicOrders)
                        {
                            // Try to find a matching material image based on SapCode
                            var materialImage = Model.MaterialImages?.FirstOrDefault(mi => mi.MaterialMaster?.material3partycode == item.SapCode);
                            <div class="product-card" data-material-id="@item.Id">
                                <div class="product-image-wrapper">
                                    <img src="@(materialImage?.ImagePath ?? "https://placehold.co/600x600/cccccc/000000?text=No+Image")"
                                         alt="@item.MaterialName" class="product-image"
                                         onerror="this.onerror=null;this.src='https://placehold.co/600x600/cccccc/000000?text=No+Image';">
                                </div>
                                <div class="product-content">
                                    <h3 class="product-title">@item.MaterialName</h3>
                                    <p class="product-sku">SAP: @item.SapCode</p>
                                    <p class="product-sku">Short Code: @item.ShortCode</p>
                                    <div class="product-price-row">
                                        <span class="product-price">₹@item.Rate</span>
                                    </div>
                                    <div class="quantity-section">
                                        <label class="quantity-label">Qty:</label>
                                        <div class="quantity-controls">
                                            <button class="quantity-btn" onclick="changeQuantity(this, -1, @item.Id)">-</button>
                                            <input type="number" class="quantity-input" value="@item.Quantity" min="1" data-material-id="@item.Id">
                                            <button class="quantity-btn" onclick="changeQuantity(this, 1, @item.Id)">+</button>
                                        </div>
                                    </div>
                                    @*<button class="add-to-cart-btn" onclick="updateCartItem(@item.Id, this)" style="margin-top:0.5rem;">
                                        Update in Cart
                                    </button>*@
                                </div>
                            </div>
                        }
                    </div>

                    <button type="button" class="checkout-btn" style="margin-top:1rem;width:100%" onclick="reorderWithUpdatedQuantities()">
                        Add All Items to Cart
                    </button>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">No previous orders found.</div>
                </div>
            }
        </div>

        <!-- Categories -->
        <div class="categories-section">
            <h2 class="section-header">Shop by Category</h2>
            @if (Model.Materials?.Any() == true)
            {
                var categories = Model.Materials.Select(m => m.Category).Distinct().ToList();
                <div class="category-grid">
                    <!-- All Products Button -->
                    <div class="category-card all-products-card" onclick="showAllProducts()">
                        <div class="category-overlay">
                            <div class="category-content">
                                <h3 class="category-name">All Products</h3>
                                <p class="category-count">@Model.Materials.Count() items</p>
                            </div>
                        </div>
                    </div>
                    @foreach (var category in categories)
                    {
                        var count = Model.Materials.Count(m => m.Category == category);
                        <div class="category-card" style="background-image:url('@GetCategoryImageUrl(category)')" onclick="showCategoryProducts('@category')">
                            <div class="category-overlay">
                                <div class="category-content">
                                    <h3 class="category-name">@category</h3>
                                    <p class="category-count">@count items</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">No categories available.</div>
                </div>
            }
        </div>

        <!-- Category Products (Hidden by default) -->
        <div id="categoryProductsSection" class="products-section" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                <h2 class="section-header" id="categorySectionTitle">Category Products</h2>
                <button class="btn btn-secondary" onclick="hideCategoryProducts()" style="padding:0.5rem 1rem;font-size:0.9rem;">Back</button>
            </div>
            <div id="categoryProductsGrid" class="products-grid"></div>
        </div>

        <!-- All Products -->
        <div class="products-section" id="allProductsSection">
            <h2 class="section-header">All Products</h2>
            @if (Model.Materials?.Any() == true)
            {
                <div class="products-grid">
                    @foreach (var m in Model.Materials.Where(x => x.isactive))
                    {
                        var img = Model.MaterialImages?.FirstOrDefault(mi => mi.MaterialMaster?.material3partycode == m.material3partycode);
                        <div class="product-card" data-category="@m.Category">
                            <div class="product-image-wrapper">
                                <img src="@(img?.ImagePath ?? "https://placehold.co/600x600/cccccc/000000?text=No+Image")"
                                     alt="@m.Materialname" class="product-image"
                                     onerror="this.onerror=null;this.src='https://placehold.co/600x600/cccccc/000000?text=No+Image';">
                            </div>
                            <div class="product-content">
                                <h3 class="product-title">@m.Materialname</h3>
                                <p class="product-shortname">@m.ShortName</p>
                                <p class="product-sku">SKU: @m.material3partycode</p>
                                <div class="product-price-row">
                                    <span class="product-price">₹@m.dealerprice</span>
                                    <span class="product-points">Pts: @GetPointsForMaterial(m.Id)</span>
                                </div>
                                <div class="quantity-section">
                                    <label class="quantity-label">Qty:</label>
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="changeQuantity(this, -1)">-</button>
                                        <input type="number" class="quantity-input" value="1" min="1" onchange="updateQuantity(this)">
                                        <button class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                                    </div>
                                </div>
                                <button class="add-to-cart-btn" onclick="addToCart(this, '@m.material3partycode', '@m.Materialname', @m.dealerprice, @m.Id)">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">No products available.</div>
                </div>
            }
        </div>

        <!-- Cart -->
        <div class="cart-container" id="cartContainer">
            <div class="cart-header">
                <h3 class="cart-title">Your Cart</h3>
                <button class="close-cart" onclick="toggleCart()">×</button>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cartTotal">₹0.00</span>
                </div>
                <div class="cart-actions">
                    <button class="clear-cart-btn" onclick="clearCart()">Clear Cart</button>
                    <button class="checkout-btn" onclick="checkout()">Proceed to Checkout</button>
                </div>
            </div>
        </div>
        <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
        <div class="cart-icon-container" onclick="toggleCart()">
            <i class="fas fa-shopping-cart cart-icon"></i>
            <span class="cart-count" id="cartCount">0</span>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="@Url.Action("DealerHome", "Home")" class="nav-item @(ViewContext.RouteData.Values["action"]?.ToString() == "DealerHome" && ViewContext.RouteData.Values["controller"]?.ToString() == "Home" ? "active" : "")">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="@Url.Action("ViewCampaigns", "Home")" class="nav-item @(ViewContext.RouteData.Values["action"]?.ToString() == "ViewCampaigns" && ViewContext.RouteData.Values["controller"]?.ToString() == "Home" ? "active" : "")">
                <i class="fas fa-bullhorn"></i>
                <span>Campaigns</span>
            </a>
            <a href="@Url.Action("Index", "Orders")" class="nav-item @(ViewContext.RouteData.Values["action"]?.ToString() == "Index" && ViewContext.RouteData.Values["controller"]?.ToString() == "Orders" ? "active" : "")">
                <i class="fas fa-shopping-bag"></i>
                <span>Orders</span>
            </a>
            <a href="@Url.Action("PointsDetails", "Home")" class="nav-item">
                <i class="fas fa-coins"></i>
                <span>Points</span>
            </a>
            <a href="@Url.Action("Vouchers", "Home")" class="nav-item">
                <i class="fas fa-ticket-alt"></i>
                <span>Vouchers</span>
            </a>
            <a href="@Url.Action("History", "Home")" class="nav-item">
                <i class="fas fa-history"></i>
                <span>History</span>
            </a>
        </nav>
    </div>

    <!-- JavaScript -->
    <script>
        const materialsData = @Html.Raw(Json.Serialize(Model.Materials));
        const materialImagesData = @Html.Raw(Json.Serialize(Model.MaterialImages));
        const dealerBasicOrdersData = @Html.Raw(Json.Serialize(Model.RecentDealerBasicOrders)) || [];
        let cart = [];

        // Create a JavaScript object to store material points data
        const materialPointsData = {
            @foreach (var material in Model.Materials)
            {
                @:@material.Id: @GetPointsForMaterial(material.Id),
            }
        };

        // Create a JavaScript version of GetPointsForMaterial function
        function getPointsForMaterialJS(materialId) {
            // Return the points from our pre-calculated data
            if (materialPointsData[materialId] !== undefined) {
                return materialPointsData[materialId];
            }
            
            // Fallback to simple calculation based on dealer price
            // Note: JSON serialization converts property names to camelCase
            const material = materialsData.find(m => m.id == materialId);
            if (!material) return 0;
            
            return Math.floor(material.dealerprice / 10);
        }

        function changeQuantity(btn, delta, materialId) {
            const input = btn.parentElement.querySelector('.quantity-input');
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            input.value = val;
        }

        function updateQuantity(input) {
            let val = parseInt(input.value);
            if (isNaN(val) || val < 1) val = 1;
            input.value = val;
        }

        function addToCart(btn, sku, name, price, materialId) {
            const input = btn.parentElement.querySelector('.quantity-input');
            const qty = parseInt(input.value) || 1;
            const item = cart.find(i => i.sku === sku);
            if (item) item.quantity += qty;
            else cart.push({ sku, name, price, quantity: qty, materialId });
            updateCartDisplay();
            input.value = 1;
            btn.textContent = 'Added!';
            btn.style.background = 'var(--success)';
            setTimeout(() => { btn.textContent = 'Add to Cart'; btn.style.background = ''; }, 1000);
        }

        function updateCartDisplay() {
            const itemsDiv = document.getElementById('cartItems');
            const countSpan = document.getElementById('cartCount');
            const totalSpan = document.getElementById('cartTotal');

            const totalItems = cart.reduce((s, i) => s + i.quantity, 0);
            countSpan.textContent = totalItems;
            
            // Add visual indicator even when cart is empty
            if (totalItems === 0) {
                countSpan.classList.add('cart-count-empty');
            } else {
                countSpan.classList.remove('cart-count-empty');
            }

            if (cart.length === 0) {
                itemsDiv.innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:2rem;">Your cart is empty</p>';
                totalSpan.textContent = '₹0.00';
                return;
            }

            let html = '';
            let total = 0;
            let totalPoints = 0;
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                // Calculate points for this item using JavaScript function
                const pointsPerUnit = getPointsForMaterialJS(item.materialId);
                const itemPoints = pointsPerUnit * item.quantity;
                totalPoints += itemPoints;
                
                // Try to find the material image
                let imageUrl = 'https://placehold.co/60x60/cccccc/000000?text=Product';
                // Note: JSON serialization converts property names to camelCase
                const material = materialsData.find(m => m.id == item.materialId);
                if (material) {
                    const materialImage = materialImagesData.find(mi => mi.materialMaster?.material3partycode === material.material3partycode);
                    if (materialImage) {
                        imageUrl = materialImage.imagePath;
                    }
                }
                
                html += `
                    <div class="cart-item" data-cart-index="${index}">
                        <div class="cart-item-image">
                            <img src="${imageUrl}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/cccccc/000000?text=Product';">
                        </div>
                        <div class="cart-item-details">
                            <h4 class="cart-item-name">${item.name}</h4>
                            <p class="cart-item-price">₹${item.price.toFixed(2)}</p>
                            <p class="cart-item-points">Points: ${itemPoints}</p>
                            <div class="cart-item-quantity-controls">
                                <button class="quantity-btn" onclick="changeCartItemQuantity(${index}, -1)">-</button>
                                <input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateCartItemQuantity(${index}, this.value)">
                                <button class="quantity-btn" onclick="changeCartItemQuantity(${index}, 1)">+</button>
                            </div>
                            <div class="cart-item-actions">
                                <button class="remove-item" onclick="removeFromCart('${item.sku}')">Remove</button>
                            </div>
                        </div>
                    </div>`;
            });
            itemsDiv.innerHTML = html;
            totalSpan.textContent = `₹${total.toFixed(2)} (Pts: ${totalPoints})`;
        }

        function changeCartItemQuantity(index, delta) {
            if (index >= 0 && index < cart.length) {
                let newQuantity = cart[index].quantity + delta;
                if (newQuantity < 1) newQuantity = 1;
                cart[index].quantity = newQuantity;
                updateCartDisplay();
            }
        }

        function updateCartItemQuantity(index, newQuantity) {
            const qty = parseInt(newQuantity);
            if (index >= 0 && index < cart.length && !isNaN(qty) && qty > 0) {
                cart[index].quantity = qty;
                updateCartDisplay();
            }
        }

        function removeFromCart(sku) {
            cart = cart.filter(i => i.sku !== sku);
            updateCartDisplay();
        }

        function toggleCart() {
            document.getElementById('cartContainer').classList.toggle('open');
            document.getElementById('cartOverlay').classList.toggle('open');
        }

        async function placeOrder() {
            if (cart.length === 0) return alert('Cart is empty!');
            if (!confirm('Place order with saved details?')) return;

            // Debug information
            console.log('Cart contents:', cart);
            
            // Validate cart items
            for (let i = 0; i < cart.length; i++) {
                const item = cart[i];
                if (!item.materialId || item.materialId <= 0) {
                    alert(`Invalid material ID for item ${item.name}. Please check the browser console for more details.`);
                    console.error('Invalid cart item:', item);
                    return;
                }
                if (!item.quantity || item.quantity <= 0) {
                    alert(`Invalid quantity for item ${item.name}. Please check the browser console for more details.`);
                    console.error('Invalid cart item:', item);
                    return;
                }
                if (item.price === undefined || item.price < 0) {
                    alert(`Invalid price for item ${item.name}. Please check the browser console for more details.`);
                    console.error('Invalid cart item:', item);
                    return;
                }
            }

            // Calculate points for each item in the cart
            const data = { 
                items: cart.map(i => { 
                    // Find the material to get its points
                    const pointsPerUnit = getPointsForMaterialJS(i.materialId);
                    return {
                        MaterialId: i.materialId, 
                        Quantity: i.quantity, 
                        Price: i.price,
                        Points: pointsPerUnit * i.quantity // Total points for this item (points per unit * quantity)
                    };
                }) 
            };
            
            // Debug information
            console.log('Order data being sent:', data);
            
            try {
                const res = await fetch('/Orders/Create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`Failed with status ${res.status}: ${errorText}`);
                }
                const json = await res.json();
                alert(`Order placed! ID: ${json.OrderId}`);
                cart = []; updateCartDisplay();
            } catch (e) {
                console.error('Error placing order:', e);
                alert(`Error placing order: ${e.message}`);
            }
        }

        function checkout() {
            if (cart.length === 0) return alert('Cart is empty!');
            if (confirm('Proceed to checkout?')) placeOrder();
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('Are you sure you want to clear your cart?')) {
                cart = [];
                updateCartDisplay();
            }
        }

        function reorderWithUpdatedQuantities() {
            const cards = document.querySelectorAll('.recent-order-container .product-card');
            if (cards.length === 0) return alert('No items to reorder!');

            // Clear cart and add all items with updated quantities
            cart = [];
            
            cards.forEach(card => {
                const mid = parseInt(card.getAttribute('data-material-id'));
                const qty = parseInt(card.querySelector('.quantity-input').value) || 1;
                
                // For DealerBasicOrder items, we need to find them in the model data
                // First, let's try to find if this is a DealerBasicOrder item
                // Note: JSON serialization converts property names to camelCase
                const dealerBasicOrderItem = dealerBasicOrdersData.find(item => item.id === mid);
                
                if (dealerBasicOrderItem) {
                    // Handle DealerBasicOrder item
                    // We need to find the corresponding MaterialMaster item for this DealerBasicOrder
                    // We'll match based on sapCode/material3partycode
                    const material = materialsData.find(m => m.material3partycode === dealerBasicOrderItem.sapCode);
                    
                    if (material) {
                        cart.push({
                            sku: dealerBasicOrderItem.sapCode,
                            name: dealerBasicOrderItem.materialName,
                            price: dealerBasicOrderItem.rate,
                            quantity: qty,
                            materialId: material.id  // Use the MaterialMaster ID, not the DealerBasicOrder ID
                        });
                    } else {
                        // If we can't find a matching material, we'll still add it but with a warning
                        cart.push({
                            sku: dealerBasicOrderItem.sapCode,
                            name: dealerBasicOrderItem.materialName,
                            price: dealerBasicOrderItem.rate,
                            quantity: qty,
                            materialId: mid
                        });
                    }
                } else {
                    // Handle regular material (existing implementation)
                    // Note: JSON serialization converts property names to camelCase
                    const m = materialsData.find(x => x.id === mid);
                    if (m) {
                        cart.push({
                            sku: m.material3partycode,
                            name: m.materialname,
                            price: m.dealerprice,
                            quantity: qty,
                            materialId: mid
                        });
                    }
                }
            });

            if (cart.length === 0) {
                // Additional debugging information
                console.log('No valid items found. Debug info:');
                console.log('Total cards:', cards.length);
                console.log('DealerBasicOrders data:', dealerBasicOrdersData);
                console.log('Materials data:', materialsData);
                console.log('Processed items:', cart);
                return alert('No valid items! Please check the browser console for more details.');
            }
            
            // Update cart display instead of placing order directly
            updateCartDisplay();
            
            // Show success message
            alert(`Added ${cart.length} items to cart. You can now add more items from the product catalog before checkout.`);
            
            // Scroll to cart icon to indicate where items were added
            document.querySelector('.cart-icon-container').scrollIntoView({ behavior: 'smooth' });
        }

        function showDetails(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        function showCategoryProducts(cat) {
            // Note: JSON serialization converts property names to camelCase
            const filtered = materialsData.filter(m => m.category === cat);
            document.getElementById('categorySectionTitle').textContent = cat + ' Products';
            let html = '';
            filtered.forEach(m => {
                const img = materialImagesData?.find(i => i.materialMaster?.material3partycode === m.material3partycode)?.imagePath || 'https://placehold.co/600x600/cccccc/000000?text=No+Image';
                html += `
                    <div class="product-card" data-category="${m.category}">
                        <div class="product-image-wrapper">
                            <img src="${img}" alt="${m.materialname}" class="product-image" onerror="this.onerror=null;this.src='https://placehold.co/600x600/cccccc/000000?text=No+Image';">
                        </div>
                        <div class="product-content">
                            <h3 class="product-title">${m.materialname}</h3>
                            <p class="product-shortname">${m.shortName}</p>
                            <p class="product-sku">SKU: ${m.material3partycode}</p>
                            <div class="product-price-row">
                                <span class="product-price">₹${m.dealerprice}</span>
                                <span class="product-points">Pts: ${Math.floor(m.dealerprice / 10)}</span>
                            </div>
                            <div class="quantity-section">
                                <label class="quantity-label">Qty:</label>
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="changeQuantity(this, -1)">-</button>
                                    <input type="number" class="quantity-input" value="1" min="1" onchange="updateQuantity(this)">
                                    <button class="quantity-btn" onclick="changeQuantity(this, 1)">+</button>
                                </div>
                            </div>
                            <button class="add-to-cart-btn" onclick="addToCart(this, '${m.material3partycode}', '${m.materialname}', ${m.dealerprice}, ${m.id})">
                                Add to Cart
                            </button>
                        </div>
                    </div>`;
            });
            document.getElementById('categoryProductsGrid').innerHTML = html;
            document.getElementById('allProductsSection').style.display = 'none';
            document.getElementById('categoryProductsSection').style.display = 'block';
        }

        function showAllProducts() {
            document.getElementById('categoryProductsSection').style.display = 'none';
            document.getElementById('allProductsSection').style.display = 'block';
            // Scroll to the All Products section
            document.getElementById('allProductsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function hideCategoryProducts() {
            document.getElementById('categoryProductsSection').style.display = 'none';
            document.getElementById('allProductsSection').style.display = 'block';
        }

        // Initialize Carousel
        document.addEventListener('DOMContentLoaded', () => {
            const el = document.getElementById('posterCarousel');
            if (el && typeof bootstrap !== 'undefined') {
                new bootstrap.Carousel(el, { interval: 5000, pause: 'hover' });
            }
        });
    </script>
}